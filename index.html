<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitcoin Fee Heatmap</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:        #0c0c0c;
      --surface:   #141414;
      --border:    #222;
      --text:      #e8e0d4;
      --muted:     #5a5248;
      --orange:    #f7931a;
      --orange-dim:#7a3d00;

      /* fee colors computed inline via JS gradient */
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── NOISE OVERLAY ── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
      opacity: 0.6;
    }

    .page { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 48px 24px 80px; }

    /* ── HEADER ── */
    header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding-bottom: 24px;
      margin-bottom: 32px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .btc-symbol {
      width: 52px; height: 52px;
      background: var(--orange);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      color: #000;
      flex-shrink: 0;
      box-shadow: 0 0 30px rgba(247,147,26,0.4);
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(28px, 5vw, 48px);
      letter-spacing: 0.04em;
      line-height: 1;
      color: var(--text);
    }
    h1 span { color: var(--orange); }

    .subtitle { font-size: 11px; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-top: 4px; }

    /* ── STATS BAR ── */
    .stats {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      margin-bottom: 36px;
    }

    .stat {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 14px 20px;
      flex: 1;
      min-width: 140px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .stat:hover { border-color: var(--orange-dim); }
    .stat::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 3px; height: 100%;
      background: var(--orange);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .stat:hover::before { opacity: 1; }

    .stat-label { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .stat-value { font-size: 22px; font-weight: 700; color: var(--text); line-height: 1; }
    .stat-unit  { font-size: 11px; color: var(--muted); margin-top: 3px; }

    /* ── CONTROLS ── */
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .controls label { font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); }

    .toggle-group { display: flex; gap: 2px; }
    .toggle-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.08em;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.15s;
      text-transform: uppercase;
    }
    .toggle-btn:hover { color: var(--text); border-color: var(--orange-dim); }
    .toggle-btn.active {
      background: var(--orange);
      border-color: var(--orange);
      color: #000;
      font-weight: 700;
    }

    /* ── HEATMAP ── */
    .heatmap-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 24px 24px 16px;
    }

    /* One row per year */
    .year-block {
      margin-bottom: 20px;
    }
    .year-block:last-child { margin-bottom: 0; }

    .year-header {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .year-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 18px;
      color: var(--orange);
      width: 46px;
      flex-shrink: 0;
      line-height: 1;
    }
    .month-labels {
      display: flex;
      flex: 1;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
    }

    .grid-outer {
      display: flex;
      gap: 0;
    }

    .day-labels {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-right: 6px;
      padding-top: 2px;
      width: 28px;
      flex-shrink: 0;
    }
    .day-label {
      height: 11px;
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.08em;
      line-height: 11px;
      user-select: none;
      text-align: right;
    }

    .grid {
      display: flex;
      gap: 2px;
    }

    .week-col {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cell {
      width: 11px;
      height: 11px;
      border-radius: 1px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      flex-shrink: 0;
    }
    .cell:hover {
      transform: scale(1.8);
      z-index: 10;
      position: relative;
      box-shadow: 0 0 10px 2px rgba(247,147,26,0.7);
    }
    .cell.empty { background: transparent; cursor: default; }
    .cell.empty:hover { transform: none; box-shadow: none; }

    /* color tiers */
    .fee-0 { background: var(--c0); }

    /* ── LEGEND ── */
    .legend {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 16px;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.1em;
    }
    .legend-cells { display: flex; gap: 2px; }
    .legend-cell { width: 11px; height: 11px; border-radius: 1px; }
    .legend-gradient {
      flex: 1;
      height: 11px;
      border-radius: 2px;
      background: linear-gradient(to right,
        rgb(0,0,0), rgb(80,10,0), rgb(160,35,0),
        rgb(220,80,0), rgb(247,147,26),
        rgb(255,210,80), rgb(255,240,160), rgb(255,255,255));
      margin: 0 8px;
    }

    /* ── TOOLTIP ── */
    #tooltip {
      position: fixed;
      background: #1e1e1e;
      border: 1px solid var(--orange);
      padding: 10px 14px;
      font-size: 11px;
      pointer-events: none;
      z-index: 1000;
      display: none;
      max-width: 200px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    #tooltip .tip-date { color: var(--muted); font-size: 10px; margin-bottom: 4px; letter-spacing: 0.1em; }
    #tooltip .tip-val  { color: var(--orange); font-size: 16px; font-weight: 700; }
    #tooltip .tip-unit { color: var(--muted); font-size: 10px; margin-top: 2px; }
    #tooltip .tip-blocks { color: var(--muted); font-size: 10px; margin-top: 4px; }

    /* ── STATUS / LOADING ── */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.1em;
      margin-top: 12px;
    }
    .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--orange);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .dot.static { animation: none; }
    .dot.error  { background: #c0392b; animation: none; }
    @keyframes pulse {
      0%,100% { opacity:1; } 50% { opacity:0.2; }
    }

    /* ── FOOTER ── */
    footer {
      margin-top: 56px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    footer a { color: var(--orange); text-decoration: none; font-size: 11px; letter-spacing: 0.08em; }
    footer a:hover { text-decoration: underline; }
    footer p { font-size: 11px; color: var(--muted); }

    /* ── SKELETON ── */
    .skeleton {
      background: linear-gradient(90deg, var(--c0) 25%, #1e1e1e 50%, var(--c0) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 1px;
    }
    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ── FADE IN ── */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 600px) {
      .stat { min-width: 120px; }
      .heatmap-wrap { padding: 16px; }
    }

    /* ── DRILL-DOWN POPOVER ── */
    #drill-panel {
      display: none;
      position: fixed;
      z-index: 1000;
      width: 300px;
      background: #1a1a1a;
      border: 1px solid var(--orange);
      padding: 18px 20px 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.8), 0 0 0 1px rgba(247,147,26,0.15);
      animation: popIn 0.15s ease forwards;
      pointer-events: all;
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95) translateY(-4px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* arrow pointer */
    #drill-panel::before {
      content: '';
      position: absolute;
      width: 10px; height: 10px;
      background: #1a1a1a;
      border-left: 1px solid var(--orange);
      border-top: 1px solid var(--orange);
      transform: rotate(45deg);
    }
    #drill-panel.arrow-below::before {
      top: -6px; left: var(--arrow-left, 20px);
    }
    #drill-panel.arrow-above::before {
      bottom: -6px; left: var(--arrow-left, 20px);
      transform: rotate(225deg);
    }

    #drill-panel .drill-close {
      position: absolute;
      top: 10px; right: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 6px;
    }
    #drill-panel .drill-close:hover { color: var(--text); }

    .drill-date {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      letter-spacing: 0.06em;
      color: var(--orange);
      margin-bottom: 14px;
      padding-right: 20px;
    }

    .drill-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      margin-bottom: 14px;
    }

    .drill-stat {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 10px 12px;
    }
    .drill-stat-label { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
    .drill-stat-value { font-size: 17px; font-weight: 700; color: var(--text); line-height: 1; }
    .drill-stat-unit  { font-size: 9px; color: var(--muted); margin-top: 2px; }

    .drill-bar-wrap { margin-bottom: 14px; }
    .drill-bar-label {
      font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 6px;
    }
    .drill-bar-track {
      height: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      position: relative;
      border-radius: 1px;
    }
    .drill-bar-fill {
      height: 100%;
      border-radius: 1px;
      transition: width 0.35s ease;
    }
    .drill-bar-marker {
      position: absolute;
      top: -3px;
      width: 2px; height: 16px;
      background: rgba(255,255,255,0.5);
      transform: translateX(-50%);
    }
    .drill-percentile-label { font-size: 10px; color: var(--muted); margin-top: 5px; }

    .drill-links { display: flex; gap: 8px; flex-wrap: wrap; }
    .drill-link {
      font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase;
      color: var(--orange); text-decoration: none;
      border: 1px solid var(--orange-dim);
      padding: 5px 10px;
      transition: all 0.15s;
    }
    .drill-link:hover { background: var(--orange); color: #000; }

    /* selected cell highlight */
    .cell.selected {
      outline: 2px solid #fff;
      outline-offset: 1px;
      z-index: 20;
      position: relative;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="btc-symbol">₿</div>
      <div>
        <h1>FEE<span>MAP</span></h1>
        <div class="subtitle">Bitcoin Transaction Fee Heatmap</div>
      </div>
    </div>
    <div style="font-size:11px; color:var(--muted); text-align:right; line-height:1.8;">
      Data via blockchain.info</a><br>
      All historical data
    </div>
  </header>

  <!-- STATS BAR -->
  <div class="stats">
    <div class="stat fade-in">
      <div class="stat-label">Current Fee</div>
      <div class="stat-value" id="stat-current">—</div>
      <div class="stat-unit">sat / vByte</div>
    </div>
    <div class="stat fade-in" style="animation-delay:0.05s">
      <div class="stat-label">7-Day Avg</div>
      <div class="stat-value" id="stat-7d">—</div>
      <div class="stat-unit" id="stat-7d-unit">sat / vByte</div>
    </div>
    <div class="stat fade-in" style="animation-delay:0.1s">
      <div class="stat-label">30-Day Avg</div>
      <div class="stat-value" id="stat-30d">—</div>
      <div class="stat-unit" id="stat-30d-unit">sat / vByte</div>
    </div>
    <div class="stat fade-in" style="animation-delay:0.15s">
      <div class="stat-label">Peak (all)</div>
      <div class="stat-value" id="stat-peak">—</div>
      <div class="stat-unit" id="stat-peak-unit">sat / vByte</div>
    </div>
    <div class="stat fade-in" style="animation-delay:0.2s">
      <div class="stat-label">BTC Price</div>
      <div class="stat-value" id="stat-price">—</div>
      <div class="stat-unit">USD</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <label>Display</label>
    <div class="toggle-group">
      <button class="toggle-btn active" id="btn-sat" onclick="setMode('sat')">sat/vB</button>
      <button class="toggle-btn"        id="btn-usd" onclick="setMode('usd')">USD/tx</button>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="heatmap-wrap fade-in" style="animation-delay:0.25s">
    <div id="heatmap-years"></div>
    <div class="legend">
      <span>LOW</span>
      <div class="legend-gradient"></div>
      <span>HIGH</span>
    </div>
  </div>

  <!-- STATUS -->
  <div class="status-bar">
    <div class="dot" id="status-dot"></div>
    <span id="status-text">Connecting to mempool.space…</span>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>
      <a href="https://github.com/yourusername/bitcoin-fee-heatmap" target="_blank">★ Star on GitHub</a>
      &nbsp;·&nbsp;
      <a href="https://mempool.space/api" target="_blank">API Docs</a>
    </p>
    <p>Not financial advice. Fees in sat/vByte (median block fee rate).</p>
  </footer>
</div>

<!-- TOOLTIP -->
<div id="tooltip">
  <div class="tip-date" id="tip-date"></div>
  <div class="tip-val"  id="tip-val"></div>
  <div class="tip-unit" id="tip-unit"></div>
  <div class="tip-blocks" id="tip-blocks"></div>
</div>

<script>
// ── State ─────────────────────────────────────────────────────────────────
let mode = 'sat';          // 'sat' | 'usd'
let dailyData = {};        // { 'YYYY-MM-DD': { avgFeeRate, blocks, avgTxCount } }
let btcPrice = 0;
let currentFee = null;

// ── Utilities ─────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);

function dateKey(ts) {
  const d = new Date(ts * 1000);
  return d.toISOString().slice(0, 10);
}

function fmtDate(key) {
  const [y, m, d] = key.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[+m - 1]} ${+d}, ${y}`;
}

// Control points: [r, g, b] from dark → orange → amber → pale yellow
const GRADIENT_STOPS = [
  [0,   0,   0],   // 0%   pure black
  [80,  10,  0],   // 15%  deep red-black
  [160, 35,  0],   // 30%  dark red
  [220, 80,  0],   // 45%  burnt orange
  [247, 147, 26],  // 60%  bitcoin orange
  [255, 210, 80],  // 75%  amber
  [255, 240, 160], // 90%  pale yellow
  [255, 255, 255], // 100% pure white
];

function feeColor(rate, max) {
  if (!rate || rate <= 0) return null;
  const t = Math.min(Math.log1p(rate) / Math.log1p(max), 1);
  const s = t * (GRADIENT_STOPS.length - 1);
  const lo = Math.floor(s), hi = Math.min(lo + 1, GRADIENT_STOPS.length - 1);
  const f = s - lo;
  const [r1,g1,b1] = GRADIENT_STOPS[lo];
  const [r2,g2,b2] = GRADIENT_STOPS[hi];
  const r = Math.round(r1 + (r2-r1)*f);
  const g = Math.round(g1 + (g2-g1)*f);
  const b = Math.round(b1 + (b2-b1)*f);
  return `rgb(${r},${g},${b})`;
}

function formatFee(rate, forDisplay = false) {
  if (mode === 'sat') {
    return rate < 10 ? rate.toFixed(1) : Math.round(rate);
  } else {
    // Approximate: median tx ~250 vBytes, fee = rate * 250 sats, USD = sats/1e8 * price
    const usd = (rate * 250 / 1e8) * btcPrice;
    return usd < 0.01 ? '<$0.01' : `$${usd.toFixed(2)}`;
  }
}

function modeUnit() {
  return mode === 'sat' ? 'sat / vByte' : 'USD / tx (est.)';
}

// ── Build date range from earliest data point to today ───────────────────
function buildDateRange() {
  const keys = Object.keys(dailyData);
  const today = new Date(); today.setUTCHours(0,0,0,0);
  const end = today.toISOString().slice(0, 10);

  let startStr;
  if (keys.length > 0) {
    startStr = keys.slice().sort()[0];
  } else {
    const s = new Date(today); s.setUTCDate(s.getUTCDate() - 364);
    startStr = s.toISOString().slice(0, 10);
  }

  const days = [];
  const cur = new Date(startStr + 'T00:00:00Z');
  const endDate = new Date(end + 'T00:00:00Z');
  while (cur <= endDate) {
    days.push(cur.toISOString().slice(0, 10));
    cur.setUTCDate(cur.getUTCDate() + 1);
  }
  return days;
}

// ── Helper: day-of-week offset (Mon=0 … Sun=6) ───────────────────────────
function dowOffset(dateStr) {
  const d = new Date(dateStr + 'T00:00:00Z').getUTCDay(); // 0=Sun
  return d === 0 ? 6 : d - 1; // convert to Mon=0
}

// ── Skeleton render ───────────────────────────────────────────────────────
function renderSkeleton() {
  const wrap = $('heatmap-years');
  wrap.innerHTML = '';
  // Just show a single placeholder row
  const block = document.createElement('div');
  block.className = 'year-block';
  block.innerHTML = `
    <div class="year-header">
      <div class="year-label" style="background:#1e1e1e;width:38px;height:18px;border-radius:2px"></div>
    </div>
    <div class="grid-outer">
      <div class="day-labels">
        <div class="day-label">MON</div><div class="day-label"></div>
        <div class="day-label">WED</div><div class="day-label"></div>
        <div class="day-label">FRI</div><div class="day-label"></div>
        <div class="day-label">SUN</div>
      </div>
      <div class="grid">${Array(53).fill('<div class="week-col">' + Array(7).fill('<div class="cell skeleton"></div>').join('') + '</div>').join('')}</div>
    </div>`;
  wrap.appendChild(block);
}

// ── Full render — one row per calendar year ───────────────────────────────
function render() {
  const wrap = $('heatmap-years');
  wrap.innerHTML = '';

  const allKeys = Object.keys(dailyData);
  if (!allKeys.length) return;

  const rates = allKeys.map(k => dailyData[k].avgFeeRate).filter(Boolean);
  const sorted = [...rates].sort((a, b) => a - b);
  const maxRate = sorted.length ? sorted[Math.floor(sorted.length * 0.99)] : 100;

  const earliestYear = parseInt(allKeys.sort()[0].slice(0, 4));
  const currentYear  = new Date().getUTCFullYear();
  const monthNames   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for (let year = currentYear; year >= earliestYear; year--) {
    const isCurrentYear = year === currentYear;
    const yearEnd = isCurrentYear
      ? new Date().toISOString().slice(0, 10)
      : `${year}-12-31`;

    // Build every calendar day Jan 1 → Dec 31 (or today)
    const yearDays = [];
    const cur = new Date(`${year}-01-01T00:00:00Z`);
    const end = new Date(yearEnd + 'T00:00:00Z');
    while (cur <= end) {
      yearDays.push(cur.toISOString().slice(0, 10));
      cur.setUTCDate(cur.getUTCDate() + 1);
    }

    // ── Build grid columns ──────────────────────────────────────────────
    const pad = dowOffset(`${year}-01-01`);
    const weeks = []; // array of 7-slot arrays
    let week = new Array(pad).fill(null); // null = empty padding

    yearDays.forEach(key => {
      if (week.length === 7) { weeks.push(week); week = []; }
      week.push(key);
    });
    if (week.length) {
      while (week.length < 7) week.push(null);
      weeks.push(week);
    }

    // ── Month label positions ──────────────────────────────────────────
    // For each month, find which week column its 1st day lands in
    const monthCols = {}; // month index (0-11) → week column index
    weeks.forEach((wk, wi) => {
      wk.forEach(key => {
        if (!key) return;
        const m = parseInt(key.slice(5, 7)) - 1;
        const d = parseInt(key.slice(8, 10));
        if (d <= 7 && monthCols[m] === undefined) monthCols[m] = wi;
      });
    });

    // ── DOM ────────────────────────────────────────────────────────────
    const block = document.createElement('div');
    block.className = 'year-block';

    // header: year + month labels
    const header = document.createElement('div');
    header.className = 'year-header';

    const yl = document.createElement('div');
    yl.className = 'year-label';
    yl.textContent = year;
    header.appendChild(yl);

    const monthRow = document.createElement('div');
    monthRow.className = 'month-labels';
    monthRow.style.position = 'relative';
    monthRow.style.height = '14px';
    monthRow.style.flex = '1';

    const CELL_W = 13;
    Object.entries(monthCols).forEach(([m, col]) => {
      const span = document.createElement('span');
      span.textContent = monthNames[+m];
      span.style.cssText = `position:absolute;left:${col * CELL_W}px;white-space:nowrap;overflow:hidden`;
      monthRow.appendChild(span);
    });
    header.appendChild(monthRow);

    // grid
    const gridOuter = document.createElement('div');
    gridOuter.className = 'grid-outer';

    const dayLabels = document.createElement('div');
    dayLabels.className = 'day-labels';
    ['MON','','WED','','FRI','','SUN'].forEach(t => {
      const d = document.createElement('div');
      d.className = 'day-label';
      d.textContent = t;
      dayLabels.appendChild(d);
    });

    const grid = document.createElement('div');
    grid.className = 'grid';

    weeks.forEach(wk => {
      const weekEl = document.createElement('div');
      weekEl.className = 'week-col';
      wk.forEach(key => {
        const cell = document.createElement('div');
        if (!key) {
          cell.className = 'cell empty';
        } else {
          const entry = dailyData[key];
          const rate  = entry?.avgFeeRate ?? null;
          const color = feeColor(rate, maxRate);
          cell.className = 'cell' + (color ? '' : ' fee-0');
          if (color) cell.style.background = color;
          cell.addEventListener('mouseenter', e => showTip(e, key, rate, entry));
          cell.addEventListener('mousemove',  e => moveTip(e));
          cell.addEventListener('mouseleave', hideTip);
          cell.addEventListener('click', () => openDrill(key, rate, cell));
        }
        weekEl.appendChild(cell);
      });
      grid.appendChild(weekEl);
    });

    gridOuter.appendChild(dayLabels);
    gridOuter.appendChild(grid);
    block.appendChild(header);
    block.appendChild(gridOuter);
    wrap.appendChild(block);
  }

  updateStats(maxRate);
}
function updateStats(maxRate) {
  // Build recent days directly without depending on buildDateRange
  if (currentFee !== null) {
    $('stat-current').textContent = currentFee;
  }

  const today = new Date(); today.setUTCHours(0,0,0,0);
  const recentDays = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(today); d.setUTCDate(d.getUTCDate() - i);
    recentDays.push(d.toISOString().slice(0, 10));
  }
  const recent7  = recentDays.slice(-7).map(d => dailyData[d]?.avgFeeRate).filter(Boolean);
  const recent30 = recentDays.map(d => dailyData[d]?.avgFeeRate).filter(Boolean);
  const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;

  const a7  = avg(recent7);
  const a30 = avg(recent30);

  $('stat-7d').textContent  = a7  !== null ? (mode === 'sat' ? (a7  < 10 ? a7.toFixed(1)  : Math.round(a7))  : formatFee(a7))  : '—';
  $('stat-30d').textContent = a30 !== null ? (mode === 'sat' ? (a30 < 10 ? a30.toFixed(1) : Math.round(a30)) : formatFee(a30)) : '—';
  $('stat-peak').textContent = maxRate > 0 ? (mode === 'sat' ? Math.round(maxRate) : formatFee(maxRate)) : '—';

  ['stat-7d-unit','stat-30d-unit','stat-peak-unit'].forEach(id => {
    $(id).textContent = modeUnit();
  });

  if (btcPrice) $('stat-price').textContent = `$${btcPrice.toLocaleString()}`;
}

// ── Tooltip ───────────────────────────────────────────────────────────────
function showTip(e, key, rate, entry) {
  const tip = $('tooltip');
  $('tip-date').textContent = fmtDate(key);
  if (rate !== null) {
    $('tip-val').textContent  = mode === 'sat'
      ? `${rate < 10 ? rate.toFixed(1) : Math.round(rate)}`
      : formatFee(rate);
    $('tip-unit').textContent = modeUnit();
    $('tip-blocks').textContent = entry?.interpolated ? 'est. (interpolated)' : (entry?.blocks ? `${entry.blocks} blocks` : '');
  } else {
    $('tip-val').textContent  = 'No data';
    $('tip-unit').textContent = '';
    $('tip-blocks').textContent = '';
  }
  tip.style.display = 'block';
  moveTip(e);
}

function moveTip(e) {
  const tip = $('tooltip');
  const x = e.clientX + 14;
  const y = e.clientY - 40;
  tip.style.left = `${Math.min(x, window.innerWidth - 220)}px`;
  tip.style.top  = `${Math.max(y, 8)}px`;
}

function hideTip() { $('tooltip').style.display = 'none'; }

// ── Mode toggle ───────────────────────────────────────────────────────────
function setMode(m) {
  mode = m;
  $('btn-sat').classList.toggle('active', m === 'sat');
  $('btn-usd').classList.toggle('active', m === 'usd');
  render();
}

// ── API Fetching ──────────────────────────────────────────────────────────
// Fetch one year's worth of daily data from blockchain.info
// timespan=1year gives daily resolution; fetching year-by-year avoids the
// sampled/weekly data that timespan=all returns for older periods.

function ingestChartPair(feesValues, txValues) {
  const txByDay = {};
  txValues.forEach(p => { txByDay[p.x] = p.y; });
  feesValues.forEach(p => {
    const ts      = p.x;
    const feesBtc = p.y;
    const txCount = txByDay[ts] ?? 300000;
    const rate    = (feesBtc * 1e8) / (txCount * 250);
    if (rate > 0) dailyData[dateKey(ts)] = { avgFeeRate: rate };
  });
}

async function fetchYearChunk(startTs) {
  const base = 'https://api.blockchain.info/charts';
  const qs   = `start=${startTs}&timespan=1year&format=json&cors=true`;
  const [fR, tR] = await Promise.all([
    fetch(`${base}/transaction-fees?${qs}`),
    fetch(`${base}/n-transactions?${qs}`),
  ]);
  if (!fR.ok || !tR.ok) throw new Error(`HTTP ${fR.status}/${tR.status}`);
  const [fD, tD] = await Promise.all([fR.json(), tR.json()]);
  ingestChartPair(fD.values ?? [], tD.values ?? []);
}

async function fetchCurrentFees() {
  try {
    const r = await fetch('https://api.blockchair.com/bitcoin/stats');
    const d = await r.json();
    const fee = d?.data?.suggested_transaction_fee_per_byte_sat;
    if (fee) { currentFee = fee; $('stat-current').textContent = fee; }
  } catch {}
}

async function fetchBTCPrice() {
  try {
    const r = await fetch('https://api.blockchain.info/ticker');
    const d = await r.json();
    btcPrice = d?.USD?.last ?? 0;
    if (btcPrice) $('stat-price').textContent = `$${Math.round(btcPrice).toLocaleString()}`;
  } catch {}
}

async function fetchFeeHistory() {
  const currentYear = new Date().getUTCFullYear();
  const startYear   = 2009;

  // Build unix timestamps for Jan 1 of each year
  const yearStarts = [];
  for (let y = startYear; y <= currentYear; y++) {
    yearStarts.push(Math.floor(new Date(`${y}-01-01T00:00:00Z`).getTime() / 1000));
  }

  setStatus(`Fetching ${yearStarts.length} years of daily data…`, false);

  // Fetch all years in parallel (blockchain.info handles it fine)
  const results = await Promise.allSettled(yearStarts.map(ts => fetchYearChunk(ts)));

  const failed = results.filter(r => r.status === 'rejected').length;
  const days   = Object.keys(dailyData).length;

  if (days === 0) {
    setStatus('Failed to load data — check console', true);
    return false;
  }

  const msg = failed > 0
    ? `Loaded ${days} days (${failed} year chunks failed)`
    : `Loaded ${days} days of data`;
  setStatus(msg, failed > 0);
  render();
  checkHash();
  return true;
}

// ── Drill-down panel ──────────────────────────────────────────────────────
let selectedCell = null;

function openDrill(key, rate, cellEl) {
  // Deselect previous
  if (selectedCell) selectedCell.classList.remove('selected');
  selectedCell = cellEl;
  cellEl.classList.add('selected');

  // Update URL hash
  history.replaceState(null, '', `#${key}`);

  const panel = $('drill-panel');
  panel.style.display = 'block';

  // Position popover near the clicked cell
  const rect    = cellEl.getBoundingClientRect();
  const pw      = 300;   // panel width
  const margin  = 8;
  const scrollY = window.scrollY;

  // Horizontal: align left edge of popover with cell, clamp to viewport
  let left = rect.left + window.scrollX;
  if (left + pw > window.innerWidth - margin) {
    left = window.innerWidth - pw - margin;
  }
  if (left < margin) left = margin;

  // Vertical: prefer below cell, flip above if no room
  const spaceBelow = window.innerHeight - rect.bottom;
  const panelH = 280; // approximate
  let top;
  if (spaceBelow >= panelH + margin) {
    top = rect.bottom + scrollY + margin;
    panel.className = 'arrow-below';
  } else {
    top = rect.top + scrollY - panelH - margin;
    panel.className = 'arrow-above';
  }

  // Arrow horizontal position relative to popover
  const arrowLeft = Math.min(Math.max(rect.left + window.scrollX - left + rect.width/2, 12), pw - 20);
  panel.style.setProperty('--arrow-left', arrowLeft + 'px');

  panel.style.left = left + 'px';
  panel.style.top  = top  + 'px';

  // Date
  $('drill-date').textContent = fmtDate(key);

  // Fee rate
  if (rate !== null) {
    $('drill-fee').textContent = rate < 10 ? rate.toFixed(2) : Math.round(rate);
    $('drill-fee-unit').textContent = 'sat / vByte';

    // USD cost estimate
    const usd = btcPrice ? (rate * 250 / 1e8) * btcPrice : null;
    $('drill-usd').textContent = usd ? (usd < 0.01 ? '<$0.01' : `$${usd.toFixed(2)}`) : '—';

    // vs today
    if (currentFee !== null) {
      const ratio = rate / currentFee;
      if (ratio > 1.01) {
        $('drill-vs').textContent = `${ratio.toFixed(1)}× higher`;
        $('drill-vs').style.color = '#f7931a';
      } else if (ratio < 0.99) {
        $('drill-vs').textContent = `${(1/ratio).toFixed(1)}× lower`;
        $('drill-vs').style.color = '#6ecf8a';
      } else {
        $('drill-vs').textContent = 'Same as today';
        $('drill-vs').style.color = 'var(--text)';
      }
      $('drill-vs-unit').textContent = `today = ${currentFee} sat/vB`;
    } else {
      $('drill-vs').textContent = '—';
    }

    // Percentile across all data
    const allRates = Object.values(dailyData).map(d => d.avgFeeRate).filter(Boolean).sort((a,b) => a-b);
    const rank = allRates.filter(r => r <= rate).length;
    const pct  = Math.round((rank / allRates.length) * 100);
    $('drill-pct').textContent = `${pct}th`;

    // Bar: fill shows percentile position, marker shows today
    const logRate = Math.log1p(rate);
    const logMax  = Math.log1p(Math.max(...allRates));
    const barPct  = Math.round((logRate / logMax) * 100);
    const fillColor = feeColor(rate, Math.max(...allRates));
    $('drill-bar-fill').style.width  = `${barPct}%`;
    $('drill-bar-fill').style.background = fillColor ?? 'var(--orange)';

    // Today marker
    if (currentFee !== null) {
      const todayPct = Math.round((Math.log1p(currentFee) / logMax) * 100);
      $('drill-bar-marker').style.left = `${todayPct}%`;
      $('drill-bar-marker').style.display = 'block';
    }

    const minR = Math.round(allRates[0]);
    const maxR = Math.round(allRates[allRates.length - 1]);
    $('drill-range-label').textContent = `Historical range: ${minR} – ${maxR} sat/vB`;
  } else {
    $('drill-fee').textContent = 'No data';
    $('drill-usd').textContent = '—';
    $('drill-vs').textContent  = '—';
    $('drill-pct').textContent = '—';
    $('drill-bar-fill').style.width = '0%';
  }

  // Links
  $('drill-mempool-link').href = `https://mempool.space/block-audits?date=${key}`;
  $('drill-share-link').onclick = (e) => {
    e.preventDefault();
    navigator.clipboard.writeText(window.location.href).then(() => {
      $('drill-share-link').textContent = 'Copied!';
      setTimeout(() => $('drill-share-link').textContent = 'Copy link to this day', 1500);
    });
  };
}

function closeDrill() {
  $('drill-panel').style.display = 'none';
  if (selectedCell) { selectedCell.classList.remove('selected'); selectedCell = null; }
  history.replaceState(null, '', window.location.pathname);
}

// Open panel on load if URL has a date hash
function checkHash() {
  const hash = window.location.hash.slice(1);
  if (/^\d{4}-\d{2}-\d{2}$/.test(hash) && dailyData[hash]) {
    // Find and click the right cell — just open the panel directly
    openDrill(hash, dailyData[hash].avgFeeRate, document.createElement('div'));
  }
}


function setStatus(msg, error = false) {
  $('status-text').textContent = msg;
  const dot = $('status-dot');
  dot.className = error ? 'dot error' : 'dot static';
}

// ── Init ──────────────────────────────────────────────────────────────────
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDrill();
});

document.addEventListener('click', e => {
  const panel = $('drill-panel');
  if (panel.style.display === 'block'
      && !panel.contains(e.target)
      && !e.target.classList.contains('cell')) {
    closeDrill();
  }
});

async function init() {
  renderSkeleton();
  setStatus('Connecting…', false);

  await Promise.all([fetchCurrentFees(), fetchBTCPrice()]);
  await fetchFeeHistory();

  setInterval(fetchCurrentFees, 60_000);
}

init();
</script>
<!-- DRILL-DOWN POPOVER (fixed, anchored to clicked cell) -->
<div id="drill-panel">
  <button class="drill-close" onclick="closeDrill()">✕</button>
  <div class="drill-date" id="drill-date"></div>
  <div class="drill-grid">
    <div class="drill-stat">
      <div class="drill-stat-label">Fee Rate</div>
      <div class="drill-stat-value" id="drill-fee">—</div>
      <div class="drill-stat-unit" id="drill-fee-unit">sat / vByte</div>
    </div>
    <div class="drill-stat">
      <div class="drill-stat-label">Est. Tx Cost</div>
      <div class="drill-stat-value" id="drill-usd">—</div>
      <div class="drill-stat-unit">USD (250 vB tx)</div>
    </div>
    <div class="drill-stat">
      <div class="drill-stat-label">vs. Today</div>
      <div class="drill-stat-value" id="drill-vs">—</div>
      <div class="drill-stat-unit" id="drill-vs-unit"></div>
    </div>
    <div class="drill-stat">
      <div class="drill-stat-label">Percentile</div>
      <div class="drill-stat-value" id="drill-pct">—</div>
      <div class="drill-stat-unit">of all days</div>
    </div>
  </div>
  <div class="drill-bar-wrap">
    <div class="drill-bar-label">Position in historical range</div>
    <div class="drill-bar-track">
      <div class="drill-bar-fill" id="drill-bar-fill"></div>
      <div class="drill-bar-marker" id="drill-bar-marker"></div>
    </div>
    <div class="drill-percentile-label" id="drill-range-label"></div>
  </div>
  <div class="drill-links">
    <a class="drill-link" id="drill-mempool-link" href="#" target="_blank">mempool.space →</a>
    <a class="drill-link" id="drill-share-link" href="#">Copy link</a>
  </div>
</div>
</body>
</html>